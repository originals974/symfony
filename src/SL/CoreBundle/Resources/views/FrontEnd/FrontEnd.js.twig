<script type="text/javascript">    
	$(document).ready(function () {
        
        var currentJsTreeReferenceId; 

        //JsTree init configuration
        function initJsTree(jsTreeId, entityClassTechnicalName) {
            $('#'+jsTreeId)
            .jstree({
                'core' : {
                    "check_callback" : true,
                    "multiple" : false,
                    'data' : {
                        'url' :  function (node) {
                                        var pattern; 
                                        pattern = $('#sl_core_search_searchField').val(); 
                                        return Routing.generate('search_result', { pattern : pattern, entityClassTechnicalName : entityClassTechnicalName });
                        },
                        'data' : function (data) {
                            return data;
                        }
                    }
                },
                "plugins" : [ "wholerow"],
            })
            .on('changed.jstree', function (e, data) {

                var $htmlTarget, i, j;

                currentJsTreeReferenceId = e.currentTarget.id; 

                $htmlTarget = '#features_panel_body'; 
                $($htmlTarget).html(null);

                for(i = 0, j = data.selected.length; i < j; i++) {
                    var $url = data.instance.get_node(data.selected[0]).a_attr['href']; 
                }

                if($url != null && $url != '#' ) {
                    sendToAjaxFrontEnd('POST', $url, null, $htmlTarget);                                
                }
            });
        };

        //When submit a form
		$(document).on('submit', 'form', function(event) {
            if($(this).attr('mode') != "search") {
                $(this).find('button[type="submit"]').attr('disabled', true);
            } 
            
            submitFormToAjaxFrontEnd($(this));
            
            return false;
        });

		/**
	     * Process submitted form by using ajax
	     *
	     * @param $form Submitted form
	     */
        function submitFormToAjaxFrontEnd($form) {

        	var validTarget, noValidTarget, method, modalId, selectedNode, reSelectedNode, guid, mode, entityClassesTechnicalName, n;
            var selectedJsTree, jsTree, jsTreeId, jsTreeIds;  

        	validTarget = '#'+$form.attr('valid-target'); 
        	noValidTarget = '#'+$form.attr('no-valid-target'); 
            mode = $form.attr('mode');

            $.ajax({
                type: $form.attr('method'),
                url: $form.attr('action'),
                data: $form.serializeArray(),
                dataType : "json",    
                success: function(data) {
                	if(data.isValid) {

                        //Get the modal id  
                        modalId = '#'+$($form).parent().parent().attr('id');
                        selectedJsTree = $('#'+currentJsTreeReferenceId).jstree(true); 

                        alert(mode); 

                        if(mode == 'add'){
                            //Refresh all search results
                            /*$('#search_result_panel').find('div[id*="jstree"]').each(function(){
                                jsTreeId = $(this).attr('id'); 
                                currentJsTreeReference = $('#'+jsTreeId).jstree(true);
                                currentJsTreeReference.refresh();
                            });*/
                        }
                        else if(mode == 'update') {
                            selectedNode = selectedJsTree.get_selected(true);  
                            reSelectedNode = selectedJsTree.get_node(selectedNode[0].id);
                            
                            //Rename all node for all jstree reference
                            guid = selectedNode[0].li_attr['guid'];
                            $('#search_result_panel').find('div[id*="jstree_"]').each(function(){

                                jsTreeId = $(this).attr('id'); 
                                jsTree = $('#'+jsTreeId).jstree(true);
                                jsTreeIds = [];
                                $(this).find('li[guid="'+guid+'"]').each(function(){
                                    jsTreeIds[jsTreeIds.length] = $(this).attr('id');
                                });

                                jsTree.rename_node(jsTreeIds, data.content);
                            });

                            selectedJsTree.deselect_node(selectedNode);
                            selectedJsTree.select_node(reSelectedNode);
                        }
                        else if(mode == 'delete') {
                            selectedNode = selectedJsTree.get_selected(true);  
                            reSelectedNode = selectedJsTree.get_node(selectedNode[0].id);

                            //Delete all node for all jstree reference
                            guid = selectedNode[0].li_attr['guid'];
                            $('#search_result_panel').find('div[id*="jstree_"]').each(function(){

                                jsTreeId = $(this).attr('id'); 
                                jsTree = $('#'+jsTreeId).jstree(true);
                                jsTreeIds = [];
                                $(this).find('li[guid="'+guid+'"]').each(function(){
                                    jsTreeIds[jsTreeIds.length] = $(this).attr('id');
                                });

                                jsTree.delete_node(jsTreeIds);
                            });
                        }
                        else if(mode == 'search') {
                            $(validTarget).html(data.content);

                            $('#search_result_panel').find('div[id*="jstree_"]').each(function(){

                                jsTreeId = $(this).attr('id'); 

                                //Extract entityClass technical name
                                n =  jsTreeId.search("_"); 
                                entityClassesTechnicalName = jsTreeId.substring(n);

                                initJsTree(jsTreeId, entityClassesTechnicalName);

                                $('#'+jsTreeId).jstree(true).refresh();

                            });
                        }
                        else if(mode == 'revert') {
                            selectedNode = selectedJsTree.get_selected(true);  
                            reSelectedNode = selectedJsTree.get_node(selectedNode[0].id);
                            selectedJsTree.deselect_node(selectedNode);
                            selectedJsTree.select_node(reSelectedNode);
                        }

                        //Close the modal
                        $(modalId).modal('hide'); 
                    }
                    else {
						$(noValidTarget).html(data.content);
		            }
                },
                error: function(data) {
                    alert('error');
                }
            });
        };

        /**
         * Submit data by using ajax
         *
         * @param String $method Ajax method used to send data
         * @param String $url  Url where data are send
         * @param JSonArray $data Data to send
         * @param String $htmlTarget Html section to modify after success
         *
         */
        function sendToAjaxFrontEnd($method, $url, $data, $htmlTarget) {
            $.ajax({
                type: $method,
                url: $url,
                data: $data,
                success: function(data) {
                    $($htmlTarget).html(data);
                },
                error: function(data) {            
                    alert('error');
                }
            }); 
        };
	}); 
</script>